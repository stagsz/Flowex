# Flowex Implementation Plan

**Last Updated:** 2026-01-19
**Status:** In Progress
**Generated by:** Ralph (Planning Mode)

---

## Current Focus

**Phase 6: Export Features** - DXF generation and data list exports.

---

## Completed Tasks

### Phase 1.1 Project Infrastructure
- [x] Initialize monorepo structure (frontend/, backend/, ml/)
- [x] Set up frontend project (React + TypeScript + Vite + Tailwind)
- [x] Set up backend project (Python + FastAPI + SQLAlchemy)
- [x] Configure Docker Compose for local development
- [x] Configure environment variables management (.env.example)
- [x] Set up ESLint for frontend
- [x] Set up Ruff + mypy for backend (pyproject.toml)
- [x] Write initial README with setup instructions

### Phase 1.2 Database Schema
- [x] Create organizations table
- [x] Create users table with SSO fields
- [x] Create projects table
- [x] Create drawings table
- [x] Create symbols table
- [x] Create lines table
- [x] Create text_annotations table
- [x] Set up Alembic migrations
- [x] Create initial migration

### Phase 1.3 Authentication (SSO)
- [x] Implement Auth0 JWKS client for token verification
- [x] Implement JWT token validation
- [x] Create authentication dependencies (get_current_user)
- [x] Implement OAuth login flow (/auth/login)
- [x] Implement OAuth callback handler (/auth/callback)
- [x] Implement token refresh endpoint (/auth/refresh) - `86e24f4`
- [x] Implement logout endpoint (/auth/logout)
- [x] Implement user info endpoint (/auth/me)
- [x] Implement role-based access control (RoleChecker)
- [x] Implement organization access control
- [x] Write authentication tests

### Phase 2.1 File Upload Service
- [x] Create S3 storage service (upload, download, presigned URLs)
- [x] Implement file validation (type, size, extension)
- [x] Create drawings service (CRUD operations)
- [x] Implement file upload endpoint (multipart)
- [x] Create projects API routes (CRUD)
- [x] Create drawings API routes (upload, list, get, delete)
- [x] Write file validation tests

### Phase 2.2 PDF Processing Pipeline
- [x] Set up Celery app with Redis broker
- [x] Create PDF processing task (process_drawing)
- [x] Implement PDF type detection (vector vs scanned)
- [x] Implement PDF to image conversion (PyMuPDF)
- [x] Implement image preprocessing for scanned PDFs (grayscale, contrast, binarization)
- [x] Implement image tiling for AI processing
- [x] Add processing API endpoints (start, status)
- [x] Write processing pipeline tests

### Phase 4: AI/ML Pipeline (Complete)

#### 4.1 Training Data Preparation
- [x] Create synthetic P&ID generator script
- [x] Generate training images with COCO annotations
- [x] Define 50 ISO 10628 symbol classes with categories

#### 4.2 Symbol Detection Model
- [x] Set up PyTorch training environment
- [x] Implement Custom CNN architecture (ResNet-50 + FPN)
- [x] Implement Faster R-CNN model with custom anchor sizes
- [x] Implement inference pipeline
- [x] Add ONNX export support
- [x] Write model tests

#### 4.3 OCR Pipeline (Tesseract)
- [x] Set up Tesseract OCR pipeline
- [x] Implement text region detection
- [x] Implement rotated text handling (0, 90, 180, 270)
- [x] Implement tag format validation (regex patterns)
- [x] Implement tag classification (equipment, instrument, valve, line)
- [x] Implement deduplication across rotations
- [x] Write OCR pipeline tests

#### 4.4 Integration & Association
- [x] Implement tag-to-symbol association algorithm (proximity-based)
- [x] Combine all AI outputs into unified InferenceService
- [x] Flag low-confidence items for review
- [x] Write integration tests

---

### Phase 5: Frontend MVP (Complete)

#### 5.1 Core UI Components
- [x] Set up shadcn/ui component library
- [x] Create layout components (Header, Sidebar, MainLayout)
- [x] Create authentication pages (Login, SSO callback)
- [x] Create Zustand auth store
- [x] Create dashboard page with stats
- [x] Create project list component
- [x] Create drawing list component
- [x] Create upload component (drag-and-drop)

#### 5.2 Validation Interface
- [x] Create side-by-side viewer component
- [x] Create component list (filterable)
- [x] Create edit panel for symbols
- [x] Implement validation progress tracking

---

## In Progress

### Phase 6: Export Features

---

## Backlog (Prioritized)

### Phase 6: Export Functionality (Weeks 12-13)

#### 5.1 AutoCAD Export
- [ ] Implement DXF generation (ezdxf)
- [ ] Create ISO 10628 symbol block library
- [ ] Implement layer structure
- [ ] Implement symbol placement
- [ ] Implement line drawing
- [ ] Implement text placement
- [ ] Implement title block
- [ ] Generate DWG from DXF (if needed)
- [ ] Write export tests

#### 5.2 Data List Exports
- [ ] Implement Equipment List generator (Excel, CSV, PDF)
- [ ] Implement Line List generator
- [ ] Implement Instrument List generator
- [ ] Implement Valve List generator
- [ ] Implement MTO generator
- [ ] Implement Comparison Report generator
- [ ] Create formatted Excel templates
- [ ] Write export tests

### Phase 6: Integrations (Week 14)

#### 6.1 Cloud Storage
- [ ] Implement Microsoft Graph API integration
- [ ] Implement OneDrive file picker
- [ ] Implement SharePoint site browser
- [ ] Implement Google Drive API integration
- [ ] Implement file import from cloud
- [ ] Implement file export to cloud
- [ ] Implement token refresh logic
- [ ] Write integration tests

### Phase 7: Testing & Polish (Weeks 15-16)

#### 7.1 Testing
- [ ] Write E2E tests (Playwright)
- [ ] Perform security audit
- [ ] Perform performance testing
- [ ] Fix identified issues

#### 7.2 Deployment
- [ ] Set up CI/CD pipeline
- [ ] Configure production environment (AWS/Azure)
- [ ] Set up monitoring (Sentry, logs)
- [ ] Deploy to staging
- [ ] Beta testing with pilot customers
- [ ] Deploy to production

---

## Discovered Issues

_None yet._

---

## Technical Decisions

| Decision | Rationale | Date |
|----------|-----------|------|
| Use FastAPI over Django | Async support, better performance, simpler for API-only backend | 2026-01-18 |
| Use Tesseract over cloud OCR | GDPR compliance (no data leaves EU), cost savings, customizable | 2026-01-18 |
| Use ezdxf for CAD export | Open source, well-documented, sufficient for DXF generation | 2026-01-18 |
| Start with synthetic training data | Faster iteration, no dependency on labeled real data initially | 2026-01-18 |

---

## Notes for Ralph

- Always run tests before committing
- Keep tasks atomic - one task = one commit
- Update this plan after completing each task
- Document any blockers or discoveries
- If a task is too large, break it down first

---

*This plan will be updated by Ralph during building mode.*
