# Flowex Implementation Plan

**Last Updated:** 2026-01-19 (Added ECS migration task definition for deployment)
**Status:** In Progress
**Generated by:** Ralph (Planning Mode)

---

## Current Focus

**Phase 8: Testing & Polish** - Ready for staging deployment. See `docs/STAGING_DEPLOYMENT.md` for deployment checklist.

---

## Completed Tasks

### Phase 1.1 Project Infrastructure
- [x] Initialize monorepo structure (frontend/, backend/, ml/)
- [x] Set up frontend project (React + TypeScript + Vite + Tailwind)
- [x] Set up backend project (Python + FastAPI + SQLAlchemy)
- [x] Configure Docker Compose for local development
- [x] Configure environment variables management (.env.example)
- [x] Set up ESLint for frontend
- [x] Set up Ruff + mypy for backend (pyproject.toml)
- [x] Write initial README with setup instructions

### Phase 1.2 Database Schema
- [x] Create organizations table
- [x] Create users table with SSO fields
- [x] Create projects table
- [x] Create drawings table
- [x] Create symbols table
- [x] Create lines table
- [x] Create text_annotations table
- [x] Set up Alembic migrations
- [x] Create initial migration

### Phase 1.3 Authentication (SSO)
- [x] Implement Auth0 JWKS client for token verification
- [x] Implement JWT token validation
- [x] Create authentication dependencies (get_current_user)
- [x] Implement OAuth login flow (/auth/login)
- [x] Implement OAuth callback handler (/auth/callback)
- [x] Implement token refresh endpoint (/auth/refresh) - `86e24f4`
- [x] Implement logout endpoint (/auth/logout)
- [x] Implement user info endpoint (/auth/me)
- [x] Implement role-based access control (RoleChecker)
- [x] Implement organization access control
- [x] Write authentication tests

### Phase 2.1 File Upload Service
- [x] Create S3 storage service (upload, download, presigned URLs)
- [x] Implement file validation (type, size, extension)
- [x] Create drawings service (CRUD operations)
- [x] Implement file upload endpoint (multipart)
- [x] Create projects API routes (CRUD)
- [x] Create drawings API routes (upload, list, get, delete)
- [x] Write file validation tests

### Phase 2.2 PDF Processing Pipeline
- [x] Set up Celery app with Redis broker
- [x] Create PDF processing task (process_drawing)
- [x] Implement PDF type detection (vector vs scanned)
- [x] Implement PDF to image conversion (PyMuPDF)
- [x] Implement image preprocessing for scanned PDFs (grayscale, contrast, binarization)
- [x] Implement image tiling for AI processing
- [x] Add processing API endpoints (start, status)
- [x] Write processing pipeline tests

### Phase 4: AI/ML Pipeline (Complete)

#### 4.1 Training Data Preparation
- [x] Create synthetic P&ID generator script
- [x] Generate training images with COCO annotations
- [x] Define 50 ISO 10628 symbol classes with categories

#### 4.2 Symbol Detection Model
- [x] Set up PyTorch training environment
- [x] Implement Custom CNN architecture (ResNet-50 + FPN)
- [x] Implement Faster R-CNN model with custom anchor sizes
- [x] Implement inference pipeline
- [x] Add ONNX export support
- [x] Write model tests

#### 4.3 OCR Pipeline (Tesseract)
- [x] Set up Tesseract OCR pipeline
- [x] Implement text region detection
- [x] Implement rotated text handling (0, 90, 180, 270)
- [x] Implement tag format validation (regex patterns)
- [x] Implement tag classification (equipment, instrument, valve, line)
- [x] Implement deduplication across rotations
- [x] Write OCR pipeline tests

#### 4.4 Integration & Association
- [x] Implement tag-to-symbol association algorithm (proximity-based)
- [x] Combine all AI outputs into unified InferenceService
- [x] Flag low-confidence items for review
- [x] Write integration tests

---

### Phase 5: Frontend MVP (Complete)

#### 5.1 Core UI Components
- [x] Set up shadcn/ui component library
- [x] Create layout components (Header, Sidebar, MainLayout)
- [x] Create authentication pages (Login, SSO callback)
- [x] Create Zustand auth store
- [x] Create dashboard page with stats
- [x] Create project list component
- [x] Create drawing list component
- [x] Create upload component (drag-and-drop)

#### 5.2 Validation Interface
- [x] Create side-by-side viewer component
- [x] Create component list (filterable)
- [x] Create edit panel for symbols
- [x] Implement validation progress tracking
- [x] Add rotation control for P&ID viewing (default 90° for landscape) - `3f8cfa3`
- [x] Fix P&ID viewer aspect ratio and rotation defaults (A1/A3 ratio, 0° default) - `0d150b5`

### Phase 6: Export Features (Complete)

#### 6.1 AutoCAD Export
- [x] Implement DXF generation (ezdxf)
- [x] Create ISO 10628 symbol block library (50 symbol classes)
- [x] Implement layer structure (11 layers per spec)
- [x] Implement symbol placement with block references
- [x] Implement line drawing with proper layers
- [x] Implement text placement
- [x] Implement title block generation
- [x] Write export tests

#### 6.2 Data List Exports
- [x] Implement Equipment List generator (Excel, CSV, PDF)
- [x] Implement Line List generator
- [x] Implement Instrument List generator
- [x] Implement Valve List generator
- [x] Implement MTO generator
- [x] Implement Comparison Report generator
- [x] Create formatted Excel templates with styling
- [x] Write export tests

#### 6.3 Export API Endpoints
- [x] POST /api/v1/exports/drawings/{id}/dxf - DXF export
- [x] POST /api/v1/exports/drawings/{id}/lists - Data list export
- [x] POST /api/v1/exports/drawings/{id}/report - Comparison report
- [x] GET /api/v1/exports/jobs/{id}/status - Job status
- [x] GET /api/v1/exports/jobs/{id}/download - Download export

### Phase 7: Cloud Storage Integrations (Complete)

#### 7.1 Backend Infrastructure
- [x] Create CloudConnection database model
- [x] Add config settings for Microsoft and Google OAuth
- [x] Create token encryption utility (Fernet)
- [x] Implement cloud storage service interfaces

#### 7.2 Provider Implementations
- [x] Implement Microsoft Graph API service (OneDrive/SharePoint)
- [x] Implement Google Drive API service
- [x] Implement token refresh logic
- [x] Implement SharePoint site/drive browsing

#### 7.3 API Endpoints
- [x] GET /api/v1/cloud/connections - List connections
- [x] POST /api/v1/cloud/connections/{provider}/connect - Initiate OAuth
- [x] GET /api/v1/cloud/callback/{provider} - OAuth callback
- [x] DELETE /api/v1/cloud/connections/{id} - Disconnect
- [x] GET /api/v1/cloud/connections/{id}/browse - Browse folders
- [x] GET /api/v1/cloud/connections/{id}/search - Search files
- [x] POST /api/v1/cloud/connections/{id}/import - Import files
- [x] POST /api/v1/cloud/connections/{id}/export - Export files
- [x] POST /api/v1/cloud/connections/{id}/folders - Create folder
- [x] GET /api/v1/cloud/connections/{id}/sharepoint/sites - List SharePoint sites
- [x] POST /api/v1/cloud/connections/{id}/sharepoint/configure - Configure SharePoint

#### 7.4 Background Tasks
- [x] Implement cloud import Celery task
- [x] Implement cloud export Celery task

#### 7.5 Frontend Components
- [x] Create Zustand cloud store
- [x] Create CloudConnectionCard component
- [x] Create CloudFilePicker dialog
- [x] Create CloudFolderPicker dialog
- [x] Create Settings/Integrations page
- [x] Add route for integrations page

#### 7.6 Testing
- [x] Write backend tests for cloud storage

---

## In Progress

_None_

---

### Phase 8: Testing & Polish (In Progress)

#### 8.1 Testing
- [x] Write E2E tests (Playwright) - `a73d247`
  - 65 tests covering auth, dashboard, navigation, upload, and validation flows
  - Fixed ProtectedRoute to auto-verify token on startup
  - Fixed test selectors for proper element location (exact matching, scoped selectors)
  - Added @playwright/test dependency
- [x] Perform security audit - `SECURITY_AUDIT.md`
  - SQL Injection: PASS (all queries use SQLAlchemy ORM)
  - XSS: PASS (React auto-escaping, no dangerouslySetInnerHTML)
  - Authentication: Fixed JWT algorithm documentation, added redirect URI validation
  - Secrets: .gitignore properly excludes .env, documented production requirements
  - CORS: Documented recommended production settings
  - Input Validation: PASS (Pydantic models, file validation)
  - Dependencies: Documented update recommendations
- [x] Perform performance testing
  - k6 load tests for API endpoints (smoke, load, stress, spike, soak profiles)
  - Upload stress test (10 concurrent uploads per spec)
  - Lighthouse CI for frontend Core Web Vitals (LCP < 3s, FCP < 2s)
  - pytest-benchmark for backend critical paths (PDF processing, image preprocessing)
  - GitHub Actions workflow for automated performance CI
- [x] Fix identified issues - `e3cd987`
  - Added production secrets validation (JWT_SECRET_KEY, TOKEN_ENCRYPTION_KEY)
  - Improved error message handling for production (generic messages)
  - Fixed pytest-asyncio compatibility (updated requirements.txt)
  - Fixed lint issues (unused variables, import ordering)
  - Added test conftest.py for TESTING environment variable

---

## Backlog (Prioritized)

#### 8.2 Deployment
- [x] Set up CI/CD pipeline - `8dcd214`
- [x] Add ECS migration task definition - `3b2885a`
  - Required by deploy workflow for running Alembic migrations
  - One-off Fargate task with minimal resources (256 CPU, 512MB memory)
- [x] Configure production environment (AWS)
  - Terraform infrastructure (VPC, ECS, RDS, ElastiCache, S3, CloudFront)
  - Dockerfiles for backend (Python 3.11 + Tesseract) and frontend (Node 20 + Nginx)
  - GitHub Actions deploy workflow with staging/production environments
  - AWS Secrets Manager integration in backend config
  - CloudWatch monitoring dashboard and alarms
  - Comprehensive deployment documentation (docs/DEPLOYMENT.md)
- [x] Set up monitoring (Sentry, logs) - `e32aaeb`
  - Sentry SDK for backend (FastAPI, SQLAlchemy, Celery, Redis integrations)
  - Sentry SDK for frontend (React, browser tracing, session replay)
  - Sentry error boundary with user-friendly fallback UI
  - Sentry user context set on authentication for error correlation
  - Structured logging module (JSON for production, colored for dev)
  - Request correlation IDs via X-Request-ID header middleware
  - CloudWatch log groups and alarms (configured in Terraform)
- [ ] Deploy to staging
  - See `docs/STAGING_DEPLOYMENT.md` for step-by-step checklist
  - Requires: AWS account, Auth0 tenant, domain (flowex.io or custom)
  - Requires: GitHub secrets and environment variables configuration
- [ ] Beta testing with pilot customers
- [ ] Deploy to production

---

## Discovered Issues

- [x] **Deploy workflow branch mismatch** - `a5b1def`
  - Deploy workflow triggered on `main` but default branch is `master`
  - Documentation said AWS_ACCOUNT_ID is a secret but workflow used `vars.AWS_ACCOUNT_ID`
  - Fixed both issues to align documentation with workflow

---

## Technical Decisions

| Decision | Rationale | Date |
|----------|-----------|------|
| Use FastAPI over Django | Async support, better performance, simpler for API-only backend | 2026-01-18 |
| Use Tesseract over cloud OCR | GDPR compliance (no data leaves EU), cost savings, customizable | 2026-01-18 |
| Use ezdxf for CAD export | Open source, well-documented, sufficient for DXF generation | 2026-01-18 |
| Start with synthetic training data | Faster iteration, no dependency on labeled real data initially | 2026-01-18 |

---

## Notes for Ralph

- Always run tests before committing
- Keep tasks atomic - one task = one commit
- Update this plan after completing each task
- Document any blockers or discoveries
- If a task is too large, break it down first

---

*This plan will be updated by Ralph during building mode.*
