# Flowex Implementation Plan

**Last Updated:** 2026-01-20 (Add missing symbol click-to-place complete)
**Status:** In Progress
**Generated by:** Ralph (Planning Mode)

---

## Current Focus

**Phase 8: Testing & Polish** - Validation UX improvements in progress.
- Staging URL: Railway (backend) + Vercel (frontend)
- Security: Fixed open redirect vulnerability (ff0c836)
- Security: Added rate limiting to auth endpoints (a550134)
- Security: Added security headers middleware (73b6fca)
- Security: Added Redis-based OAuth state storage (e514e8c)
- UX: Added keyboard shortcuts and undo/redo to validation interface (942a45c)
- UX: Added auto-save visual indicator to validation interface (82848e2)
- UX: Added bulk verification with multi-select (74d5438)
- UX: Added flag for review functionality (e587040)
- UX: Added full-screen mode toggle (a6024b7)
- UX: Added symbol type/classification dropdown (b1ce61c)
- UX: Added missing symbol click-to-place functionality (9e53da8)
- Next: Beta testing with pilot customers

---

## Completed Tasks

### Phase 1.1 Project Infrastructure
- [x] Initialize monorepo structure (frontend/, backend/, ml/)
- [x] Set up frontend project (React + TypeScript + Vite + Tailwind)
- [x] Set up backend project (Python + FastAPI + SQLAlchemy)
- [x] Configure Docker Compose for local development
- [x] Configure environment variables management (.env.example)
- [x] Set up ESLint for frontend
- [x] Set up Ruff + mypy for backend (pyproject.toml)
- [x] Write initial README with setup instructions

### Phase 1.2 Database Schema
- [x] Create organizations table
- [x] Create users table with SSO fields
- [x] Create projects table
- [x] Create drawings table
- [x] Create symbols table
- [x] Create lines table
- [x] Create text_annotations table
- [x] Set up Alembic migrations
- [x] Create initial migration

### Phase 1.3 Authentication (SSO)
- [x] Implement Auth0 JWKS client for token verification
- [x] Implement JWT token validation
- [x] Create authentication dependencies (get_current_user)
- [x] Implement OAuth login flow (/auth/login)
- [x] Implement OAuth callback handler (/auth/callback)
- [x] Implement token refresh endpoint (/auth/refresh) - `86e24f4`
- [x] Implement logout endpoint (/auth/logout)
- [x] Implement user info endpoint (/auth/me)
- [x] Implement role-based access control (RoleChecker)
- [x] Implement organization access control
- [x] Write authentication tests

### Phase 2.1 File Upload Service
- [x] Create S3 storage service (upload, download, presigned URLs)
- [x] Implement file validation (type, size, extension)
- [x] Create drawings service (CRUD operations)
- [x] Implement file upload endpoint (multipart)
- [x] Create projects API routes (CRUD)
- [x] Create drawings API routes (upload, list, get, delete)
- [x] Write file validation tests

### Phase 2.2 PDF Processing Pipeline
- [x] Set up Celery app with Redis broker
- [x] Create PDF processing task (process_drawing)
- [x] Implement PDF type detection (vector vs scanned)
- [x] Implement PDF to image conversion (PyMuPDF)
- [x] Implement image preprocessing for scanned PDFs (grayscale, contrast, binarization)
- [x] Implement image tiling for AI processing
- [x] Add processing API endpoints (start, status)
- [x] Write processing pipeline tests

### Phase 4: AI/ML Pipeline (Complete)

#### 4.1 Training Data Preparation
- [x] Create synthetic P&ID generator script
- [x] Generate training images with COCO annotations
- [x] Define 50 ISO 10628 symbol classes with categories

#### 4.2 Symbol Detection Model
- [x] Set up PyTorch training environment
- [x] Implement Custom CNN architecture (ResNet-50 + FPN)
- [x] Implement Faster R-CNN model with custom anchor sizes
- [x] Implement inference pipeline
- [x] Add ONNX export support
- [x] Write model tests

#### 4.3 OCR Pipeline (Tesseract)
- [x] Set up Tesseract OCR pipeline
- [x] Implement text region detection
- [x] Implement rotated text handling (0, 90, 180, 270)
- [x] Implement tag format validation (regex patterns)
- [x] Implement tag classification (equipment, instrument, valve, line)
- [x] Implement deduplication across rotations
- [x] Write OCR pipeline tests

#### 4.4 Integration & Association
- [x] Implement tag-to-symbol association algorithm (proximity-based)
- [x] Combine all AI outputs into unified InferenceService
- [x] Flag low-confidence items for review
- [x] Write integration tests

---

### Phase 5: Frontend MVP (Complete)

#### 5.1 Core UI Components
- [x] Set up shadcn/ui component library
- [x] Create layout components (Header, Sidebar, MainLayout)
- [x] Create authentication pages (Login, SSO callback)
- [x] Create Zustand auth store
- [x] Create dashboard page with stats
- [x] Create project list component
- [x] Create drawing list component
- [x] Create upload component (drag-and-drop)

#### 5.2 Validation Interface
- [x] Create side-by-side viewer component
- [x] Create component list (filterable)
- [x] Create edit panel for symbols
- [x] Implement validation progress tracking
- [x] Add rotation control for P&ID viewing (default 90° for landscape) - `3f8cfa3`
- [x] Fix P&ID viewer aspect ratio and rotation defaults (A1/A3 ratio, 0° default) - `0d150b5`
- [x] Integrate react-pdf for real PDF viewing in ValidationPage - `4296782`
- [x] Connect UploadPage to backend projects API - `14d4de7`

### Phase 6: Export Features (Complete)

#### 6.1 AutoCAD Export
- [x] Implement DXF generation (ezdxf)
- [x] Create ISO 10628 symbol block library (50 symbol classes)
- [x] Implement layer structure (11 layers per spec)
- [x] Implement symbol placement with block references
- [x] Implement line drawing with proper layers
- [x] Implement text placement
- [x] Implement title block generation
- [x] Write export tests

#### 6.2 Data List Exports
- [x] Implement Equipment List generator (Excel, CSV, PDF)
- [x] Implement Line List generator
- [x] Implement Instrument List generator
- [x] Implement Valve List generator
- [x] Implement MTO generator
- [x] Implement Comparison Report generator
- [x] Create formatted Excel templates with styling
- [x] Write export tests

#### 6.3 Export API Endpoints
- [x] POST /api/v1/exports/drawings/{id}/dxf - DXF export
- [x] POST /api/v1/exports/drawings/{id}/lists - Data list export
- [x] POST /api/v1/exports/drawings/{id}/report - Comparison report
- [x] GET /api/v1/exports/jobs/{id}/status - Job status
- [x] GET /api/v1/exports/jobs/{id}/download - Download export

### Phase 7: Cloud Storage Integrations (Complete)

#### 7.1 Backend Infrastructure
- [x] Create CloudConnection database model
- [x] Add config settings for Microsoft and Google OAuth
- [x] Create token encryption utility (Fernet)
- [x] Implement cloud storage service interfaces

#### 7.2 Provider Implementations
- [x] Implement Microsoft Graph API service (OneDrive/SharePoint)
- [x] Implement Google Drive API service
- [x] Implement token refresh logic
- [x] Implement SharePoint site/drive browsing

#### 7.3 API Endpoints
- [x] GET /api/v1/cloud/connections - List connections
- [x] POST /api/v1/cloud/connections/{provider}/connect - Initiate OAuth
- [x] GET /api/v1/cloud/callback/{provider} - OAuth callback
- [x] DELETE /api/v1/cloud/connections/{id} - Disconnect
- [x] GET /api/v1/cloud/connections/{id}/browse - Browse folders
- [x] GET /api/v1/cloud/connections/{id}/search - Search files
- [x] POST /api/v1/cloud/connections/{id}/import - Import files
- [x] POST /api/v1/cloud/connections/{id}/export - Export files
- [x] POST /api/v1/cloud/connections/{id}/folders - Create folder
- [x] GET /api/v1/cloud/connections/{id}/sharepoint/sites - List SharePoint sites
- [x] POST /api/v1/cloud/connections/{id}/sharepoint/configure - Configure SharePoint

#### 7.4 Background Tasks
- [x] Implement cloud import Celery task
- [x] Implement cloud export Celery task

#### 7.5 Frontend Components
- [x] Create Zustand cloud store
- [x] Create CloudConnectionCard component
- [x] Create CloudFilePicker dialog
- [x] Create CloudFolderPicker dialog
- [x] Create Settings/Integrations page
- [x] Add route for integrations page

#### 7.6 Testing
- [x] Write backend tests for cloud storage

---

## In Progress

_None_

---

### Phase 8.3: AI Integration (Complete)
- [x] Add AI inference to processing pipeline and symbols API
  - Integrated InferenceService into process_drawing Celery task
  - Stores detected symbols and text annotations in database
  - Created GET /api/v1/drawings/{id}/symbols endpoint
  - Created PATCH /api/v1/drawings/{id}/symbols/{id} endpoint
  - Created DELETE /api/v1/drawings/{id}/symbols/{id} endpoint
  - Created POST /api/v1/drawings/{id}/symbols/{id}/verify endpoint
  - Created PATCH /api/v1/drawings/{id}/texts/{id} endpoint
  - Updated ValidationPage to fetch real symbol data from API
  - Added edit, delete, and verify functionality to frontend

---

### Phase 8: Testing & Polish (In Progress)

#### 8.0 Validation UX Improvements
- [x] Add keyboard shortcuts to validation interface - `942a45c`
  - V: Verify, Delete: Delete, Ctrl+Z/Y: Undo/Redo, Tab: Navigate
  - 20-level undo/redo stack with API integration
  - Toast notifications for user feedback
  - Keyboard shortcuts help dialog (press ?)
  - E2E tests for keyboard shortcuts

#### 8.1 Testing
- [x] Write E2E tests (Playwright) - `a73d247`
  - 65 tests covering auth, dashboard, navigation, upload, and validation flows
  - Fixed ProtectedRoute to auto-verify token on startup
  - Fixed test selectors for proper element location (exact matching, scoped selectors)
  - Added @playwright/test dependency
- [x] Perform security audit - `SECURITY_AUDIT.md`
  - SQL Injection: PASS (all queries use SQLAlchemy ORM)
  - XSS: PASS (React auto-escaping, no dangerouslySetInnerHTML)
  - Authentication: Fixed JWT algorithm documentation, added redirect URI validation
  - Secrets: .gitignore properly excludes .env, documented production requirements
  - CORS: Documented recommended production settings
  - Input Validation: PASS (Pydantic models, file validation)
  - Dependencies: Documented update recommendations
- [x] Perform performance testing
  - k6 load tests for API endpoints (smoke, load, stress, spike, soak profiles)
  - Upload stress test (10 concurrent uploads per spec)
  - Lighthouse CI for frontend Core Web Vitals (LCP < 3s, FCP < 2s)
  - pytest-benchmark for backend critical paths (PDF processing, image preprocessing)
  - GitHub Actions workflow for automated performance CI
- [x] Fix identified issues - `e3cd987`
  - Added production secrets validation (JWT_SECRET_KEY, TOKEN_ENCRYPTION_KEY)
  - Improved error message handling for production (generic messages)
  - Fixed pytest-asyncio compatibility (updated requirements.txt)
  - Fixed lint issues (unused variables, import ordering)
  - Added test conftest.py for TESTING environment variable
- [x] Migrate Pydantic models to ConfigDict syntax - `663f1ce`
  - Updated class Config to model_config = ConfigDict(...) in API routes
  - Updated Settings to use SettingsConfigDict for pydantic-settings
  - Reduces deprecation warnings, prepares for Pydantic V3
- [x] Implement Supabase Authentication provider - `f051ece`
  - Added AUTH_PROVIDER config setting ("supabase" or "auth0")
  - Implemented Supabase OAuth login, callback, and token refresh
  - Added verify_supabase_token() for HS256 JWT verification
  - Added SUPABASE_JWT_SECRET config for token verification
  - Added global exception handler with CORS headers
  - Updated Supabase client initialization for version compatibility
- [x] Fix post-Supabase auth integration issues - `30da534`
  - Fixed import ordering in main.py (ruff I001)
  - Updated auth tests to work with both Supabase and Auth0
  - Fixed DrawingStatus enum references to lowercase values

---

## Backlog (Prioritized)

#### Validation Interface Polish (Remaining from Spec)
- [x] Auto-save visual indicator - `82848e2`
  - SaveStatusIndicator component shows saving/saved/error states
  - Visual feedback: spinner during save, checkmark when saved, cloud icon for idle
  - Displays relative time since last save (e.g., "Saved just now", "Saved 2m ago")
  - All symbol operations trigger save status updates
- [x] Bulk verification (multi-select checkbox + "Verify All" button) - `74d5438`
  - Checkbox on each symbol list item for multi-select
  - Bulk action bar with Select All/Clear/Verify All controls
  - Keyboard shortcuts: Ctrl+A (select all), V (verify selected), Space (toggle)
  - Backend POST /api/v1/drawings/{id}/symbols/bulk-verify endpoint
  - Undo/redo support for bulk operations
- [x] Flag for review functionality (mark items for human review) - `e587040`
  - Added is_flagged field to Symbol model with Alembic migration
  - POST /api/v1/drawings/{id}/symbols/{id}/flag and /unflag endpoints
  - POST /api/v1/drawings/{id}/symbols/bulk-flag and /bulk-unflag endpoints
  - Keyboard shortcut: F to flag selected item(s)
  - Flag/Unflag button in symbol editor panel
  - Flag button in bulk action bar
  - Orange flag icon indicator in symbol list
  - Flagged count in validation progress section
  - Undo/redo support for flag operations
- [x] Full-screen mode toggle - `a6024b7`
  - [Full] button in PDF toolbar with Maximize2/Minimize2 icons
  - Keyboard shortcut: G to toggle, Escape to exit full-screen
  - Fixed positioning covers entire viewport when enabled
  - Right panel (Extracted Components) hidden in full-screen
  - Updated keyboard shortcuts help dialog
- [x] Add missing symbol (click-to-place on PDF) - `9e53da8`
  - POST /api/v1/drawings/{id}/symbols endpoint for creating new symbols
  - "Add" button in PDF toolbar with keyboard shortcut (A)
  - Click-to-place mode with crosshair cursor
  - Dialog to select symbol class and enter optional tag
  - Undo/redo support for add operations
  - Symbols created manually are pre-verified
- [x] Change symbol type/classification dropdown - `b1ce61c`
  - Select dropdown in edit panel with all 50 ISO 10628 symbol classes
  - Symbol classes grouped by category (Equipment, Instruments, Valves, Other)
  - Undo/redo support for class changes
  - Auto-updates symbol category when class changes

#### 8.2 Deployment
- [x] Set up CI/CD pipeline - `8dcd214`
- [x] Add ECS migration task definition - `3b2885a`
  - Required by deploy workflow for running Alembic migrations
  - One-off Fargate task with minimal resources (256 CPU, 512MB memory)
- [x] Configure production environment (AWS)
  - Terraform infrastructure (VPC, ECS, RDS, ElastiCache, S3, CloudFront)
  - Dockerfiles for backend (Python 3.11 + Tesseract) and frontend (Node 20 + Nginx)
  - GitHub Actions deploy workflow with staging/production environments
  - AWS Secrets Manager integration in backend config
  - CloudWatch monitoring dashboard and alarms
  - Comprehensive deployment documentation (docs/DEPLOYMENT.md)
- [x] Set up monitoring (Sentry, logs) - `e32aaeb`
  - Sentry SDK for backend (FastAPI, SQLAlchemy, Celery, Redis integrations)
  - Sentry SDK for frontend (React, browser tracing, session replay)
  - Sentry error boundary with user-friendly fallback UI
  - Sentry user context set on authentication for error correlation
  - Structured logging module (JSON for production, colored for dev)
  - Request correlation IDs via X-Request-ID header middleware
  - CloudWatch log groups and alarms (configured in Terraform)
- [x] Create Supabase deployment guide (no vendor lock-in alternative)
  - See `docs/SUPABASE_DEPLOYMENT.md` for Supabase + Railway + Vercel stack
  - Cost: $0-25/month vs $60-100/month for AWS
  - Uses existing Supabase auth integration (AUTH_PROVIDER=supabase)
- [x] Deploy to staging (Supabase stack) - `2026-01-20`
  - Backend deployed to Railway (API + Celery worker)
  - Frontend deployed to Vercel
  - Supabase for auth, database, and storage
  - Upstash for Redis
- [ ] Beta testing with pilot customers
- [ ] Deploy to production

---

## Discovered Issues

- [x] **Deploy workflow branch mismatch** - `a5b1def`
  - Deploy workflow triggered on `main` but default branch is `master`
  - Documentation said AWS_ACCOUNT_ID is a secret but workflow used `vars.AWS_ACCOUNT_ID`
  - Fixed both issues to align documentation with workflow

- [x] **Pre-staging deployment fixes** - `4296782`
  - Fixed hardcoded localhost URL in ValidationPage.tsx (use VITE_API_URL)
  - Added OAuth redirect URIs to Terraform ECS task (MICROSOFT_REDIRECT_URI, GOOGLE_REDIRECT_URI)
  - Added Microsoft/Google OAuth client credentials to ECS secrets
  - Created frontend .env.example with documented environment variables
  - Updated .gitignore to exclude root-level screenshot files
  - Fixed type hints in ocr_pipeline.py and pdf_processing.py for mypy compliance

- [x] **Mypy type errors and API URL fixes** - `ad4095e`
  - Fixed mypy type errors in export services (dxf_export.py, symbol_blocks.py, data_lists.py)
  - Fixed mypy type errors in ML inference service (inference.py)
  - Fixed mypy type errors in config.py (redis.from_url untyped call)
  - Fixed frontend API URLs from /api/ to /api/v1/ prefix in DrawingsPage, UploadPage, ValidationPage

- [x] **Storage abstraction and additional mypy fixes** - `5cc038a`
  - Fixed Drawing model attribute usage in cloud.py (original_filename, file_size_bytes)
  - Refactored cloud tasks to use storage interface instead of direct S3 access
  - Added proper async/await with asyncio.run() for storage operations
  - Fixed Supabase signedUrl key (was incorrectly signedURL)
  - Added type annotations to Celery task functions and middleware
  - Reduced mypy errors from 61 to 23 (remaining are cosmetic dict type params)

- [x] **ValidationPage localhost fallback consistency** - `d4cd528`
  - Added http://localhost:8000 fallback to VITE_API_URL in ValidationPage.tsx
  - Consistent with UploadPage and DrawingsPage patterns
  - Ensures local development works without additional environment setup

- [x] **Missing auth headers on frontend API calls** - `d15290a`
  - Created centralized api.ts utility with automatic Bearer token injection
  - Updated DrawingsPage, UploadPage, ValidationPage to use authenticated fetch
  - Fixes authentication failures when backend validates JWT tokens

- [x] **Railway deployment configuration fixes** - `a77b9ab`
  - Added Railway deployment files (railway.json, nixpacks.toml, Procfile)
  - Fixed Celery import path in Procfile and docs (app.celery_app → app.core.celery_app)
  - Added extra="ignore" to Settings to handle unknown env vars (e.g., RAILWAY_TOKEN)
  - Added .env.production to .gitignore to prevent credential exposure

- [x] **Fix all mypy type errors** - `86ade81`
  - Reduced mypy errors from 41 to 0 (clean pass)
  - Fixed missing `cls` parameter in encryption.py generate_key method
  - Added proper type annotations to dict parameters across codebase
  - Fixed return type annotations in security.py, database.py, exports.py
  - Added type ignore comments for dynamic imports in inference.py
  - Updated pyproject.toml to ignore missing stubs for third-party libraries

- [x] **Remove debug startup prints from main.py** - `838b975`
  - Removed temporary debug print statements added for Railway deployment troubleshooting
  - Fixed E402 (module level import not at top of file) lint errors
  - Fixed F541 (f-string without placeholders) lint error
  - Deployment working, debug statements no longer needed

- [x] **Fix open redirect vulnerability in auth redirect URI validation** - `ff0c836`
  - Replaced naive startswith() check with proper URL parsing
  - Blocks host suffix attacks (localhost:5173.attacker.com)
  - Blocks userinfo attacks (localhost:5173@attacker.com)
  - Blocks non-http/https schemes (javascript:, data:)
  - Added 12 security tests validating against common attack vectors

- [x] **Add rate limiting to authentication endpoints** - `a550134`
  - Implemented slowapi-based rate limiting with Redis backend
  - Applied rate limits: login (10/min), callback (20/min), refresh (30/min), default (100/min)
  - Custom 429 handler with CORS headers for cross-origin requests
  - Configurable limits via environment variables
  - Falls back to in-memory storage if Redis unavailable
  - Added 6 rate limiting tests

- [x] **Add security headers middleware** - `73b6fca`
  - Implemented OWASP recommended security headers middleware
  - X-Frame-Options: DENY (clickjacking protection)
  - X-Content-Type-Options: nosniff (MIME sniffing prevention)
  - X-XSS-Protection: 1; mode=block (legacy XSS filter)
  - Referrer-Policy: strict-origin-when-cross-origin
  - Permissions-Policy: restricts camera, microphone, geolocation, payment, etc.
  - Content-Security-Policy: configurable, disabled by default
  - Strict-Transport-Security (HSTS): configurable, disabled by default
  - Cache-Control: no-store for sensitive endpoints (auth, users, cloud)
  - All settings configurable via environment variables
  - Added 24 security header tests

- [x] **Add Redis-based OAuth state storage** - `e514e8c`
  - Replaced in-memory OAuth state storage with Redis-backed implementation
  - RedisOAuthStateStorage uses atomic GETDEL for replay attack prevention
  - InMemoryOAuthStateStorage for development/testing fallback
  - 5-minute TTL with automatic expiration (CSRF protection)
  - Single-use states consumed after validation
  - Centralized state management in app.core.oauth_state
  - Removed duplicate state handling from CloudStorageService and cloud routes
  - 17 comprehensive tests covering both storage backends

---

## Technical Decisions

| Decision | Rationale | Date |
|----------|-----------|------|
| Use FastAPI over Django | Async support, better performance, simpler for API-only backend | 2026-01-18 |
| Use Tesseract over cloud OCR | GDPR compliance (no data leaves EU), cost savings, customizable | 2026-01-18 |
| Use ezdxf for CAD export | Open source, well-documented, sufficient for DXF generation | 2026-01-18 |
| Start with synthetic training data | Faster iteration, no dependency on labeled real data initially | 2026-01-18 |
| Add Supabase as auth alternative | Simpler setup for development, unified platform with storage, compatible with Auth0 | 2026-01-19 |
| Add Supabase deployment option | No vendor lock-in, lower cost ($0-25 vs $60-100/mo), simpler setup for small teams | 2026-01-20 |

---

## Notes for Ralph

- Always run tests before committing
- Keep tasks atomic - one task = one commit
- Update this plan after completing each task
- Document any blockers or discoveries
- If a task is too large, break it down first

---

*This plan will be updated by Ralph during building mode.*
