# Flowex Implementation Plan

**Last Updated:** 2026-01-18  
**Status:** Planning  
**Generated by:** Ralph (Planning Mode)

---

## Current Focus

**Phase 1: Foundation Setup** - Establish project infrastructure, database, and authentication before implementing features.

---

## Completed Tasks

_No tasks completed yet._

---

## In Progress

_No tasks in progress._

---

## Backlog (Prioritized)

### Phase 1: Foundation (Weeks 1-2)

#### 1.1 Project Infrastructure
- [ ] Initialize monorepo structure (frontend/, backend/, ml/, specs/)
- [ ] Set up frontend project (React + TypeScript + Vite + Tailwind)
- [ ] Set up backend project (Python + FastAPI + SQLAlchemy)
- [ ] Configure Docker Compose for local development
- [ ] Set up PostgreSQL database with initial schema
- [ ] Configure environment variables management
- [ ] Set up ESLint + Prettier for frontend
- [ ] Set up Ruff + mypy for backend
- [ ] Configure Git hooks (pre-commit)
- [ ] Write initial README with setup instructions

#### 1.2 Database Schema
- [ ] Create organizations table
- [ ] Create users table with SSO fields
- [ ] Create projects table
- [ ] Create drawings table
- [ ] Create symbols table
- [ ] Create lines table
- [ ] Create text_annotations table
- [ ] Create checklist_items table
- [ ] Create edit_history table
- [ ] Create usage_records table
- [ ] Set up Alembic migrations
- [ ] Create initial migration

#### 1.3 Authentication (SSO)
- [ ] Set up Auth0 tenant (or Azure AD B2C)
- [ ] Configure Microsoft SSO provider
- [ ] Configure Google SSO provider
- [ ] Implement OAuth callback handler
- [ ] Implement JWT token generation
- [ ] Implement token refresh endpoint
- [ ] Implement logout endpoint
- [ ] Create authentication middleware
- [ ] Implement role-based access control
- [ ] Write authentication tests

### Phase 2: Core Backend Services (Weeks 3-4)

#### 2.1 File Upload Service
- [ ] Set up AWS S3 bucket (EU region)
- [ ] Implement file upload endpoint (multipart)
- [ ] Implement chunked upload for large files
- [ ] Implement file validation (type, size)
- [ ] Implement virus scanning integration
- [ ] Generate unique file IDs
- [ ] Store file metadata in database
- [ ] Implement upload progress tracking
- [ ] Write upload service tests

#### 2.2 PDF Processing Pipeline
- [ ] Set up background job queue (Celery + Redis)
- [ ] Implement PDF type detection (vector vs scanned)
- [ ] Implement PDF to image conversion (pdf2image)
- [ ] Implement image pre-processing for scanned PDFs
  - [ ] Deskew correction
  - [ ] Noise reduction
  - [ ] Binarization
- [ ] Implement image tiling for AI processing
- [ ] Update drawing status during processing
- [ ] Handle processing errors gracefully
- [ ] Write processing pipeline tests

### Phase 3: AI/ML Pipeline (Weeks 5-8)

#### 3.1 Training Data Preparation
- [ ] Create synthetic P&ID generator script
- [ ] Generate 1,000 synthetic training images
- [ ] Create annotation format (COCO or custom)
- [ ] Set up labeling workflow for real P&IDs
- [ ] Prepare validation dataset (100 images)

#### 3.2 Symbol Detection Model
- [ ] Set up PyTorch training environment
- [ ] Implement Custom CNN architecture (ResNet-50 + FPN)
- [ ] Implement data augmentation pipeline
- [ ] Train model on synthetic data (Phase 1)
- [ ] Evaluate model accuracy (target: >90%)
- [ ] Implement inference pipeline
- [ ] Optimize model for production (ONNX export)
- [ ] Write model evaluation tests

#### 3.3 OCR Pipeline (Tesseract)
- [ ] Set up Tesseract with engineering fonts
- [ ] Implement text region detection
- [ ] Implement rotated text handling
- [ ] Implement OCR post-processing
- [ ] Implement tag format validation (regex)
- [ ] Implement tag classification (equipment, instrument, etc.)
- [ ] Write OCR pipeline tests

#### 3.4 Integration & Association
- [ ] Implement line detection (Hough transform)
- [ ] Implement connectivity graph builder
- [ ] Implement tag-to-symbol association algorithm
- [ ] Implement connection point detection
- [ ] Combine all AI outputs into unified result
- [ ] Flag low-confidence items for review
- [ ] Write integration tests

### Phase 4: Frontend MVP (Weeks 9-11)

#### 4.1 Core UI Components
- [ ] Set up shadcn/ui component library
- [ ] Create layout components (Header, Sidebar, Main)
- [ ] Create authentication pages (Login, SSO redirect)
- [ ] Create dashboard page
- [ ] Create project list component
- [ ] Create drawing list component
- [ ] Create upload component (drag-and-drop)
- [ ] Create progress indicators

#### 4.2 Validation Interface
- [ ] Create side-by-side viewer component
- [ ] Implement PDF viewer (left panel)
- [ ] Implement extracted drawing viewer (right panel)
- [ ] Implement synchronized zoom/pan
- [ ] Create component list (filterable, sortable)
- [ ] Implement click-to-highlight functionality
- [ ] Create edit panel for symbols
- [ ] Implement add/edit/delete symbol actions
- [ ] Implement undo/redo functionality
- [ ] Create validation checklist component
- [ ] Implement auto-save functionality
- [ ] Write UI component tests

#### 4.3 Project Management
- [ ] Create project CRUD pages
- [ ] Create user invitation flow
- [ ] Create usage tracking display
- [ ] Create settings pages

### Phase 5: Export Functionality (Weeks 12-13)

#### 5.1 AutoCAD Export
- [ ] Implement DXF generation (ezdxf)
- [ ] Create ISO 10628 symbol block library
- [ ] Implement layer structure
- [ ] Implement symbol placement
- [ ] Implement line drawing
- [ ] Implement text placement
- [ ] Implement title block
- [ ] Generate DWG from DXF (if needed)
- [ ] Write export tests

#### 5.2 Data List Exports
- [ ] Implement Equipment List generator (Excel, CSV, PDF)
- [ ] Implement Line List generator
- [ ] Implement Instrument List generator
- [ ] Implement Valve List generator
- [ ] Implement MTO generator
- [ ] Implement Comparison Report generator
- [ ] Create formatted Excel templates
- [ ] Write export tests

### Phase 6: Integrations (Week 14)

#### 6.1 Cloud Storage
- [ ] Implement Microsoft Graph API integration
- [ ] Implement OneDrive file picker
- [ ] Implement SharePoint site browser
- [ ] Implement Google Drive API integration
- [ ] Implement file import from cloud
- [ ] Implement file export to cloud
- [ ] Implement token refresh logic
- [ ] Write integration tests

### Phase 7: Testing & Polish (Weeks 15-16)

#### 7.1 Testing
- [ ] Write E2E tests (Playwright)
- [ ] Perform security audit
- [ ] Perform performance testing
- [ ] Fix identified issues

#### 7.2 Deployment
- [ ] Set up CI/CD pipeline
- [ ] Configure production environment (AWS/Azure)
- [ ] Set up monitoring (Sentry, logs)
- [ ] Deploy to staging
- [ ] Beta testing with pilot customers
- [ ] Deploy to production

---

## Discovered Issues

_None yet._

---

## Technical Decisions

| Decision | Rationale | Date |
|----------|-----------|------|
| Use FastAPI over Django | Async support, better performance, simpler for API-only backend | 2026-01-18 |
| Use Tesseract over cloud OCR | GDPR compliance (no data leaves EU), cost savings, customizable | 2026-01-18 |
| Use ezdxf for CAD export | Open source, well-documented, sufficient for DXF generation | 2026-01-18 |
| Start with synthetic training data | Faster iteration, no dependency on labeled real data initially | 2026-01-18 |

---

## Notes for Ralph

- Always run tests before committing
- Keep tasks atomic - one task = one commit
- Update this plan after completing each task
- Document any blockers or discoveries
- If a task is too large, break it down first

---

*This plan will be updated by Ralph during building mode.*
